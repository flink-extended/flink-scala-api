# This workflow will build a Java project with Maven
# For more information see: https://help.github.com/actions/language-and-framework-guides/building-and-testing-java-with-maven

name: All Tests

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  # Job 1: Full test coverage (all projects)
  java-17-full:
    runs-on: ubuntu-22.04
    env:
      JAVA_OPTIONS: '--add-opens java.base/java.lang=ALL-UNNAMED'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: sbt
      - name: Run all tests
        run: JAVA_OPTS=$JAVA_OPTIONS sbt test
      - name: Compile Scala 2.13 docs
        run: JAVA_OPTS=$JAVA_OPTIONS sbt docs/mdoc
      - name: Compile Scala 3 docs
        run: JAVA_OPTS=$JAVA_OPTIONS sbt docs3/mdoc

  # Job 2: Matrix builds for Java version compatibility (Java 17 is already tested with java-17-full)
  java-compat:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        java: [11]
        sbt-module: ['flink-common-api-1', 'flink-common-api-13', 'flink-1-api-1', 'flink-1-api-13']
        include:
          - java: 21
            sbt-module: 'flink-common-api-2'
          - java: 21
            sbt-module: 'flink-common-api-23'
          - java: 21
            sbt-module: 'flink-2-api-2'
          - java: 21
            sbt-module: 'flink-2-api-23'
    env:
      JAVA_OPTIONS: '--add-opens java.base/java.lang=ALL-UNNAMED'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ matrix.java }}
          cache: sbt
      - name: Compile Scala 2.13 Docs
        if: matrix.sbt-module == 'flink-1-api-1'
        run: JAVA_OPTS=$JAVA_OPTIONS sbt "docs/mdoc"
      - name: Compile Scala 3 Docs
        if: matrix.sbt-module == 'flink-1-api-13'
        run: JAVA_OPTS=$JAVA_OPTIONS sbt "docs3/mdoc"
      - name: Run tests on ${{ matrix.sbt-module }}
        run: JAVA_OPTS=$JAVA_OPTIONS sbt "project ${{ matrix.sbt-module }}; test"
      - name: Run tests on examples
        if: matrix.sbt-module == 'flink-1-api-13'
        run: JAVA_OPTS=$JAVA_OPTIONS sbt "project examples3; test"
